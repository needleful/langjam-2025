<!DOCTYPE html>
<html>
	<head>
		<title>Duet</title>
		<style>
			#main-content {
				display:flex;
			}
			#editor {
				flex:1.6;
			}
			#file-panel {
				flex:0.5;
			}
			#editor-root {
				position:relative;
				height: 400pt;
			}
			.code-container {
				margin: 10px;
				padding: 10px;
				border: 0;
				width: calc(100% - 32px);
				height: 400pt;
				position: absolute;
				top: 0;
				left: 0;
				overflow: scroll;
				white-space: pre;
			}
			#editor-text {
				z-index: 1;
				color: transparent;
				background: transparent;
				caret-color: black;
				resize: none;
			}
		</style>
		<script type="text/javascript">
			const Duet = {
				// A dictionary
				// name of object/file -> {path:String, text:String, type:String, element:Element}
				files: {},
				activeFile: undefined,
				switchTo: (name) => {
					if(Duet.activeFile in Duet.files) {
						Duet.files[Duet.activeFile].text = editor.text.value;
					}
					if(name in Duet.files) {
						Duet.activeFile = name;
						document.getElementById('current-file').innerText = name;
						editor.setContent(Duet.files[name].text);
						highlight();
					}
					else{
						console.error('DUET: could not switch to file: ', name);
					}
				},
				loadObject: async (path) => {
					const response = await fetch(path);
					if(!response.ok) {
						console.error('DUET: could not load file: ', path);
						return;
					}
					console.log('DUET: loading ', path);
					let item = makeChild(
						document.getElementById('files-list'),
						'li', {class: 'files-list-item'});
					let button = makeChild(item, 'button');
					let id = path;
					button.innerText = path;
					button.addEventListener('click', () => {Duet.switchTo(id)});
					Duet.files[id] = {
						type:"Beats Me",
						path: path,
						text: await response.text(),
						element: button
					};
					Duet.switchTo(id);
				},
				removeObject: (name) => {
					if(name in Duet.files) {
						Duet.files[name].element.remove();
						delete Duet.files[name];
						console.log('DUET: removed: ', name);
					}
					else {
						console.warn('DUET: No such object: ', name);
					}
				},
				compile: () => {
					console.log('DUET: Definitely compiling!!');
				}
			};
			function makeChild(parent, tag, attributes) {
				let item = document.createElement(tag);
				parent.appendChild(item);
				if (attributes) {
					Object.keys(attributes).map(function(key) {
						item.setAttribute(key, attributes[key]);
					});
				}
				return item;
			}
			Duet.loadObject('/duet/game.duet').then(() => {
				Duet.loadObject('/duet/player.duet').then(Duet.compile);
			});
		</script>
	</head>
	<body>
		<h1>Langjam Gamejam entry: Duet</h1>
		<canvas id="game-canvas" width="800" height="600">
		</canvas>
		<h2>Editor</h2>
		<h4 id='current-file'>Editing a new file</h4>
		<div id='main-content'>
			<div id="editor">
				<div id='editor-root'>
					<textarea id="editor-text" class='code-container' rows="20" 
						aria-hint="The keyboard can be captured by the text editor. Press escape to toggle this behavior." spellcheck="false"
						oninput="highlight()" onscroll="sync_scroll()">#Type code here</textarea>
					<pre id="highlighting" class='code-container' aria-hidden="true" tabindex='-1'><code id="highlighting-content" class='code-fonts'></code></pre>
				</div>
				<br></br>
				<p id='editor-status'>Tab Captured. Press Escape to Toggle</p>
				<button onclick="Duet.compile()">Compile and Run</button>
			</div>
			<div id='file-panel'>
				<h3>Files</h3>
				<input type='text' value='newFile.duet'/>
				<ul id='files-list'>
					
				</ul>
				<button>Create File</button>
			</div>
		</div>
		<script type="text/javascript" src="/editor.js"></script>
	</body>
</html>